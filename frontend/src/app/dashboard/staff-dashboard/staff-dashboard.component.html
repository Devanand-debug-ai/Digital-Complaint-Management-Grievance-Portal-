<div class="dashboard-container">
    <mat-toolbar color="accent" class="dashboard-toolbar">
        <span>{{ isAdmin ? 'Admin Dashboard' : 'Staff Dashboard' }}</span>
        <span class="spacer"></span>
        <button mat-icon-button (click)="logout()" matTooltip="Logout">
            <mat-icon>logout</mat-icon>
        </button>
    </mat-toolbar>

    <div class="content">
        <div class="complaint-grid">
            <mat-card *ngFor="let complaint of complaints" class="complaint-card"
                [ngClass]="'status-' + complaint.status + '-card'">
                <mat-card-header>
                    <mat-card-title>{{complaint.title}}</mat-card-title>
                    <mat-card-subtitle>{{complaint.category}} â€¢ {{complaint.created_at |
                        date:'mediumDate'}}</mat-card-subtitle>
                </mat-card-header>
                <mat-card-content>
                    <p>{{complaint.description}}</p>
                    <div class="status-text">
                        Current Status: <strong>{{complaint.status}}</strong>
                    </div>

                    <div *ngIf="complaint.staff" class="assigned-info">
                        <strong>Assigned to:</strong> {{complaint.staff.name}}
                    </div>

                    <!-- Resolution Notes Display -->
                    <div class="resolution-display"
                        *ngIf="complaint.status === 'Resolved' && complaint.resolutionNotes">
                        <div class="resolution-header">
                            <mat-icon>task_alt</mat-icon>
                            <span>Resolution Notes</span>
                        </div>
                        <p class="resolution-text">{{complaint.resolutionNotes}}</p>
                    </div>

                    <!-- Feedback Display -->
                    <div class="feedback-display" *ngIf="complaint.feedback || complaint.feedbackRating">
                        <div class="feedback-header">
                            <mat-icon>rate_review</mat-icon>
                            <span>User Feedback</span>
                            <div class="stars">
                                <mat-icon *ngFor="let star of [1,2,3,4,5]"
                                    [class.filled]="star <= complaint.feedbackRating">star</mat-icon>
                            </div>
                        </div>
                        <p class="feedback-text" *ngIf="complaint.feedback">"{{complaint.feedback}}"</p>
                        <p class="feedback-date" *ngIf="complaint.feedbackDate">
                            Submitted: {{complaint.feedbackDate | date:'medium'}}
                        </p>
                    </div>
                </mat-card-content>
                <mat-card-actions [align]="'end'" class="actions-row">

                    <!-- Admin: Assign Staff -->
                    <mat-form-field appearance="outline" class="status-select" *ngIf="isAdmin">
                        <mat-label>Assign Staff</mat-label>
                        <mat-select [value]="complaint.staffId"
                            (selectionChange)="assignStaff(complaint, $event.value)">
                            <mat-option *ngFor="let staff of staffList" [value]="staff.id">
                                {{staff.name}}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>

                    <!-- Staff/Admin: Update Status -->
                    <mat-form-field appearance="outline" class="status-select">
                        <mat-label>Update Status</mat-label>
                        <mat-select [value]="complaint.status"
                            (selectionChange)="updateStatus(complaint, $event.value)">
                            <mat-option *ngFor="let status of statuses" [value]="status">
                                {{status}}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>

                </mat-card-actions>
            </mat-card>

            <div *ngIf="complaints.length === 0" class="no-data">
                <mat-icon>inbox</mat-icon>
                <p>No complaints found.</p>
            </div>
        </div>
    </div>

    <!-- Resolution Notes Dialog Template -->
    <ng-template #resolutionDialog>
        <h2 mat-dialog-title>Resolve Complaint</h2>
        <mat-dialog-content>
            <p>Please provide details about the resolution.</p>
            <mat-form-field appearance="outline" class="full-width">
                <mat-label>Resolution Notes</mat-label>
                <textarea matInput [(ngModel)]="resolutionNotes" rows="4"
                    placeholder="Action taken, fixes made, etc."></textarea>
            </mat-form-field>
        </mat-dialog-content>
        <mat-dialog-actions align="end">
            <button mat-button mat-dialog-close>Cancel</button>
            <button mat-raised-button color="primary" [mat-dialog-close]="resolutionNotes"
                [disabled]="!resolutionNotes">Resolve</button>
        </mat-dialog-actions>
    </ng-template>
</div>