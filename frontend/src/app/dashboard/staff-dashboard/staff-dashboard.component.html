<div class="dashboard-container">
    <mat-toolbar class="dashboard-toolbar">
        <span>{{ isAdmin ? 'Admin Dashboard' : 'Staff Dashboard' }}</span>
        <span class="spacer"></span>
        <button mat-icon-button (click)="logout()" matTooltip="Logout">
            <mat-icon>logout</mat-icon>
        </button>
    </mat-toolbar>

    <div class="content">
        <div class="complaint-grid">
            <mat-card *ngFor="let complaint of complaints" class="complaint-card"
                [ngClass]="'status-' + complaint.status + '-card'">

                <div class="card-inner">
                    <!-- Header: Title and Top Badge -->
                    <div class="card-header-row">
                        <h3 class="card-title">{{complaint.title}}</h3>
                        <div class="status-badge" [ngClass]="'status-' + complaint.status">
                            {{complaint.status}}
                        </div>
                    </div>

                    <!-- Subtitle: Category & Meta -->
                    <div class="card-subtitle-row">
                        <span class="category">{{complaint.category}} •</span>
                        <span class="meta-info">
                            Ticket #{{complaint.id}} • {{complaint.created_at | date:'mediumDate'}}
                        </span>
                    </div>

                    <!-- Middle Status Pill (Visible if Resolved) -->
                    <div class="middle-status-pill status-Resolved" *ngIf="complaint.status === 'Resolved'">
                        <mat-icon>check_circle</mat-icon>
                        <span>RESOLVED</span>
                    </div>

                    <!-- Description -->
                    <p style="color: #475569; font-size: 14px; margin: 0 0 12px; line-height: 1.5;">
                        {{complaint.description}}
                    </p>

                    <!-- Assigned Staff Info -->
                    <div *ngIf="complaint.staff" class="assigned-info"
                        style="font-size: 13px; color: #4f46e5; font-weight: 500;">
                        Attached Staff: {{complaint.staff.name}}
                    </div>

                    <!-- Resolution Notes Block -->
                    <div class="resolution-block" *ngIf="complaint.status === 'Resolved' && complaint.resolutionNotes">
                        <div class="block-header">
                            <mat-icon>verified</mat-icon>
                            <span>RESOLUTION NOTES</span>
                        </div>
                        <div class="resolution-content">
                            <!-- Parsing lines assuming they might be split by newline, or just showing text -->
                            <div class="res-item">
                                <mat-icon>check</mat-icon>
                                <span>{{complaint.resolutionNotes}}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Feedback Block -->
                    <div class="feedback-block" *ngIf="complaint.feedback || complaint.feedbackRating">
                        <div class="block-header">
                            <div class="header-left">
                                <mat-icon>rate_review</mat-icon>
                                <span>User Feedback</span>
                            </div>
                            <div class="stars">
                                <mat-icon *ngFor="let star of [1,2,3,4,5]"
                                    [class.filled]="star <= complaint.feedbackRating">star</mat-icon>
                            </div>
                        </div>
                        <p class="feedback-text" *ngIf="complaint.feedback">"{{complaint.feedback}}"</p>
                        <p class="feedback-date" *ngIf="complaint.feedbackDate">
                            Submitted: {{complaint.feedbackDate | date:'medium'}}
                        </p>
                    </div>
                </div>

                <!-- Footer: Actions -->
                <div class="card-footer">
                    <!-- Admin Assign Staff -->
                    <mat-form-field appearance="outline" class="status-changer" *ngIf="isAdmin"
                        style="margin-right: auto;">
                        <mat-select [value]="complaint.staffId" placeholder="Assign Staff"
                            (selectionChange)="assignStaff(complaint, $event.value)">
                            <mat-option *ngFor="let staff of staffList" [value]="staff.id">
                                {{staff.name}}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>

                    <div class="status-changer">
                        <mat-form-field appearance="outline">
                            <mat-select [value]="complaint.status" placeholder="Change Status"
                                (selectionChange)="updateStatus(complaint, $event.value)">
                                <mat-option *ngFor="let status of statuses" [value]="status">
                                    {{status}}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                    </div>

                    <div class="action-buttons">
                        <button mat-icon-button matTooltip="Edit" (click)="editComplaint(complaint)">
                            <mat-icon>edit_note</mat-icon>
                        </button>
                        <button mat-icon-button matTooltip="Refresh" (click)="refresh()">
                            <mat-icon>refresh</mat-icon>
                        </button>
                    </div>
                </div>

            </mat-card>

            <!-- No Data -->
            <div *ngIf="complaints.length === 0" class="no-data">
                <mat-icon>inbox</mat-icon>
                <p>No complaints found.</p>
            </div>
        </div>
    </div>

    <!-- Resolution Dialog -->
    <ng-template #resolutionDialog>
        <h2 mat-dialog-title>Resolve Complaint</h2>
        <mat-dialog-content>
            <p>Please provide details about the resolution.</p>
            <mat-form-field appearance="outline" class="full-width" style="width: 100%;">
                <mat-label>Resolution Notes</mat-label>
                <textarea matInput [(ngModel)]="resolutionNotes" rows="4"
                    placeholder="Action taken, fixes made, etc."></textarea>
            </mat-form-field>
        </mat-dialog-content>
        <mat-dialog-actions align="end">
            <button mat-button mat-dialog-close>Cancel</button>
            <button mat-raised-button color="primary" [mat-dialog-close]="resolutionNotes"
                [disabled]="!resolutionNotes">Resolve</button>
        </mat-dialog-actions>
    </ng-template>
</div>